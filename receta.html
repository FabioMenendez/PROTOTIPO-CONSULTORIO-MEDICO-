<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Consultorio ‚Äî Receta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="app.css" />
  <style>
    :root{
      --bg:#f6f7fb; --paper:#fff; --line:#e6e9ef; --muted:#6b7280;
      --brand:#0d47a1; --brand-2:#1967d2;
    }
    body{ margin:0; background:var(--bg); color:#1f2937; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }

    /* NAV */
    .topnav{ position:sticky; top:0; z-index:10; background:#0d47a1; color:#fff; padding:10px 14px; box-shadow:0 2px 8px rgba(0,0,0,.15); }
    .topnav .wrap{ max-width:1040px; margin:0 auto; display:flex; align-items:center; gap:16px; }
    .topnav .brand{ font-weight:800; }
    .topnav nav{ margin-left:auto; display:flex; gap:10px; }
    .topnav a{ color:#dbeafe; text-decoration:none; padding:6px 10px; border-radius:8px; }
    .topnav a:hover{ background:#0b3a84; }
    .topnav a.active{ background:#0b3a84; }

    /* Shell */
    .shell{ max-width:1040px; margin:22px auto 30px; padding:0 12px; display:grid; gap:16px; }
    .card{ background:var(--paper); border:1px solid var(--line); border-radius:14px; box-shadow:0 12px 40px rgba(13,71,161,.06); }
    .card header{ padding:12px 14px; border-bottom:1px solid #eef2f7; font-weight:700; color:#0d47a1; }
    .card .body{ padding:14px; }

    .row-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width:860px){ .row-3{ grid-template-columns:1fr; } }

    .field{ display:flex; flex-direction:column; gap:6px; position:relative; }
    .field label{ font-size:13px; color:#374151; }
    .field input{ padding:10px 12px; border:1px solid #cfd8dc; border-radius:10px; background:#fbfdff; font-size:14px; }

    .status{ display:flex; align-items:center; gap:8px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #dbe7ff; background:#eef2ff; color:#334155; }
    .ok{ background:#e6f6ef; border-color:#c7eedb; color:#0f5132; }
    .warn{ background:#fff8e1; border-color:#ffe6a7; color:#7a5800; }

    .btn{ border:1px solid #cfd8dc; background:#fff; color:#123; padding:9px 12px; border-radius:10px; font-size:14px; cursor:pointer; }
    .btn:hover{ background:#f5f8ff; }
    .btn-primary{ background:#1967d2; color:#fff; border-color:#1967d2; }
    .btn-danger{ background:#ffe4e6; border-color:#fecdd3; color:#be123c; }
    .sp{ flex:1; }

    /* Toolbar & editor */
    .toolbar{ display:flex; gap:6px; flex-wrap:wrap; border:1px solid var(--line); border-radius:10px; padding:8px; background:#fbfdff; }
    .toolbar button{ padding:7px 10px; }
    .editor{ border:1px solid var(--line); border-radius:10px; min-height:200px; padding:12px; background:#fff; }
    .hint{ color:var(--muted); font-size:13px; margin-top:6px; }

    /* Sugerencias */
    .suggest-wrap{ position:relative; grid-column:1/-1; }
    .suggest{
      position:absolute; top:100%; left:0; right:0; z-index:20;
      background:#fff; border:1px solid #dbe7ff; border-radius:10px; margin-top:6px;
      box-shadow:0 10px 24px rgba(31,41,55,.12); max-height:280px; overflow:auto; display:none;
    }
    .suggest.open{ display:block; }
    .s-item{
      display:flex; align-items:center; gap:10px; padding:10px 12px; cursor:pointer;
      border-bottom:1px solid #f2f6ff;
    }
    .s-item:last-child{ border-bottom:none; }
    .s-item:hover, .s-item.active{ background:#f0f4ff; }
    .s-avatar{ width:28px; height:28px; border-radius:999px; background:#e3e9ff; color:#163; display:grid; place-items:center; font-weight:700; }
    .s-name{ font-weight:600; }
    .s-meta{ color:#64748b; font-size:12px; }

    /* Receta imprimible */
    .rx{ background:#fff; border:1px solid var(--line); border-radius:14px; padding:22px; }
    .rx header{ text-align:center; margin-bottom:6px; }
    .rx h1{ font-size:22px; margin:0 0 2px; }
    .rx h2{ font-size:16px; font-weight:500; margin:2px 0 4px; color:#374151; }
    .rx p{ margin:2px 0; }
    .rx .meta{ display:flex; justify-content:space-between; gap:10px; margin-top:10px; border-top:1px dashed #e5e7eb; padding-top:10px; }
    .rx .paciente{ display:flex; gap:22px; align-items:center; margin:10px 0 6px; }
    .rx .content{ border-top:2px solid #e5e7eb; padding-top:12px; min-height:400px; }
    .rx .sign{ display:flex; justify-content:space-between; gap:16px; align-items:flex-end; margin-top:24px; }
    .rx .firma{ width:60%; text-align:center; }
    .rx .firma .line{ border-top:2px solid #333; height:0; margin:22px 0 6px; }
    .rx .sello{ width:100%; display:flex; justify-content:flex-end; align-items:center; }
    .rx .sello img{ max-width:20%; height:auto; }

    /* Print A4 */
    @media print{
      body{ background:#fff; }
      .topnav, .card:first-of-type{ display:none !important; }
      .rx{ border:none; box-shadow:none; padding:0; }
      .shell{ margin:0 auto; padding:0; max-width: 180mm; }
      @page{ size:A4; margin:12mm; }
    }
  </style>
</head>
<body>

  <!-- NAV -->
  <header class="topnav">
    <div class="wrap">
      <div class="brand">Consultorio</div>
      <nav>
        <a href="historia.html">Agregar Nuevo Paciente</a>
        <a class="active" href="receta.html">Realizar una Receta</a>
        <a href="historias-todas.html">Historias Clincas</a>
        <a href="index.html">Regresar a Pagina web</a>
      </nav>
    </div>
  </header>

  <main class="shell">
    <!-- Captura -->
    <section class="card">
      <header>Paciente</header>
      <div class="body">
        <div class="row-3">
          <div class="field">
            <label for="apPat">Apellido paterno</label>
            <input id="apPat" autocomplete="off" />
          </div>
          <div class="field">
            <label for="apMat">Apellido materno</label>
            <input id="apMat" autocomplete="off" />
          </div>
          <div class="field">
            <label for="nombres">Nombres</label>
            <input id="nombres" autocomplete="off" />
          </div>
        </div>

        <!-- Sugerencias (autocompletar) -->
        <div class="suggest-wrap">
          <div id="suggest" class="suggest" role="listbox" aria-label="Coincidencias de pacientes"></div>
        </div>

        <div class="status" style="margin-top:8px;">
          <span id="matchState" class="pill">Esperando datos‚Ä¶</span>
          <small id="matchName" class="muted"></small>
          <div class="sp"></div>
          <button id="btnGuardar" class="btn btn-primary">üíæ Guardar receta</button>
          <button id="btnImprimir" class="btn">üñ®Ô∏è Imprimir</button>
          <button id="btnLimpiar" class="btn btn-danger">Limpiar</button>
        </div>

        <div style="height:12px"></div>
        <div class="toolbar" aria-label="Herramientas de texto">
          <button data-cmd="bold" class="btn"><strong>B</strong></button>
          <button data-cmd="italic" class="btn"><em>I</em></button>
          <button data-cmd="underline" class="btn"><u>U</u></button>
          <button data-cmd="insertUnorderedList" class="btn">‚Ä¢ Lista</button>
          <button data-cmd="insertOrderedList" class="btn">1. Lista</button>
          <button data-cmd="justifyLeft" class="btn">‚Ü§</button>
          <button data-cmd="justifyCenter" class="btn">‚Üî</button>
          <button data-cmd="justifyRight" class="btn">‚Ü¶</button>
          <button data-cmd="undo" class="btn">‚Ü∂</button>
          <button data-cmd="redo" class="btn">‚Ü∑</button>
          <button id="btnClearFormat" class="btn">Limpiar formato</button>
        </div>
        <div id="editor" class="editor" contenteditable="true" spellcheck="false"
             aria-label="Escriba la receta completa aqu√≠‚Ä¶ (indicaciones, dosis, etc.)"></div>
        <div class="hint">Escriba toda la receta aqu√≠. Puede dar formato al texto con la barra superior.</div>
      </div>
    </section>

    <!-- Hoja de receta (impresi√≥n) -->
    <section class="rx card" id="rxSheet">
      <header>
        <h1>Dr. Constantino Dom√≠nguez Barrera</h1>
        <h2>M√©dico Cirujano</h2>
        <p><strong>CMP:</strong> 2099</p>
        <p><strong>Direcci√≥n:</strong> Av. Per√∫ 3885, San Mart√≠n de Porres</p>
        <p><strong>Tel√©fono:</strong> +51 957 375 513</p>
        <p><strong>Atenci√≥n:</strong> Lunes, Mi√©rcoles y Viernes ‚Äî 4:00 p.m. a 9:00 p.m.</p>
      </header>

      <div class="meta">
        <div class="paciente"><b>Paciente:</b> <span id="rxNombre">‚Äî</span></div>
        <div><b>Fecha:</b> <span id="rxFecha">‚Äî</span></div>
      </div>

      <div class="content" id="rxContent"><!-- aqu√≠ va el HTML del editor --></div>

      <div class="sign">

        <div class="sello">
          <!-- Actualiza la ruta de la imagen combinada firma+sello -->
          <img id="imgSello" src="img/frima.jpg" alt="Firma y sello" />
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===========================
    // API CLIENT (sin IndexedDB)
    // ===========================
    const API = {
      async buscarPacientes(query){
        const url = `/api/pacientes?query=${encodeURIComponent(query||'')}`;
        try{
          const r = await fetch(url);
          if(!r.ok) throw new Error('HTTP '+r.status);
          const data = await r.json();
          return Array.isArray(data)?data:[];
        }catch(e){
          console.warn('buscarPacientes()', e);
          return [];
        }
      },
      async crearReceta(payload){
        // payload: { pacienteId, pacienteNombre, fecha, html }
        try{
          const r = await fetch(`/api/recetas`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!r.ok) throw new Error('HTTP '+r.status);
          return await r.json(); // { id }
        }catch(e){
          console.warn('crearReceta()', e);
          return null;
        }
      }
    };

    // ============= Helpers =============
    const $ = s => document.querySelector(s);
    const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim();
    const nombreCompletoDe = p => (p?.nombreCompleto || `${p?.apPat||''} ${p?.apMat||''} ${p?.nombres||''}`).replace(/\s+/g,' ').trim();

    function fechaDDMMYYYY(iso){
      if(!iso) return '‚Äî';
      const [y,m,d] = iso.split('-'); return `${d}/${m}/${y}`;
    }

    // ============= UI refs =============
    const apPat = $('#apPat'), apMat = $('#apMat'), nombres = $('#nombres');
    const suggest = $('#suggest');
    const matchState = $('#matchState'), matchName = $('#matchName');
    const editor = $('#editor');
    const btnGuardar = $('#btnGuardar'), btnImprimir = $('#btnImprimir'), btnLimpiar = $('#btnLimpiar');
    const rxNombre = $('#rxNombre'), rxFecha = $('#rxFecha'), rxContent = $('#rxContent');

    let sugerencias = [];     // resultados actuales de la API
    let pacienteSel = null;   // paciente seleccionado de la lista
    let activeIndex = -1;     // navegaci√≥n con teclado
    let debTimer;

    function setEstado(texto, cls=''){
      matchState.className = 'pill '+(cls||'');
      matchState.textContent = texto;
    }

    function closeSuggestions(){
      suggest.classList.remove('open');
      suggest.innerHTML = '';
      activeIndex = -1;
    }

    function renderSuggestions(list){
      if(!list.length){ closeSuggestions(); return; }
      suggest.classList.add('open');
      activeIndex = -1;
      suggest.innerHTML = list.map((p,i)=>{
        const viewName = nombreCompletoDe(p);
        const initials = viewName.split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('');
        return `<div class="s-item" role="option" data-i="${i}">
          <div class="s-avatar">${initials||'P'}</div>
          <div>
            <div class="s-name">${viewName}</div>
            <div class="s-meta">ID: ${p.id ?? '‚Äî'}</div>
          </div>
        </div>`;
      }).join('');
      suggest.querySelectorAll('.s-item').forEach(node=>{
        node.addEventListener('click', ()=>{
          const i = Number(node.dataset.i);
          const p = sugerencias[i];
          if(p){ choosePatient(p); }
        });
      });
    }

    function choosePatient(p){
      pacienteSel = p;
      // rellenar inputs con su nombre (no bloqueamos edici√≥n)
      const viewName = nombreCompletoDe(p);
      // intento de dividir
      const parts = viewName.split(/\s+/);
      apPat.value = p.apPat ?? parts[0] ?? '';
      apMat.value = p.apMat ?? parts[1] ?? '';
      nombres.value = p.nombres ?? parts.slice(2).join(' ');

      setEstado('Paciente OK','ok');
      matchName.textContent = viewName;
      closeSuggestions();
    }

    async function updateSuggestions(){
      pacienteSel = null;
      const a = apPat.value, b = apMat.value, c = nombres.value;
      const typed = `${a} ${b} ${c}`.trim();
      if(!typed){ setEstado('Esperando datos‚Ä¶'); matchName.textContent=''; closeSuggestions(); return; }

      setEstado('Buscando‚Ä¶');
      clearTimeout(debTimer);
      debTimer = setTimeout(async ()=>{
        const rows = await API.buscarPacientes(typed);
        // coincide exacto?
        const exact = rows.find(p => norm(p.apPat||'')===norm(a) && norm(p.apMat||'')===norm(b) && norm(p.nombres||'')===norm(c));
        if(exact){
          choosePatient(exact);
        }else{
          setEstado('Escribiendo‚Ä¶');
          matchName.textContent = '';
          sugerencias = rows.slice(0,8);
          renderSuggestions(sugerencias);
        }
      }, 220);
    }

    function onKeyNav(e){
      if(!suggest.classList.contains('open')) return;
      const items = [...suggest.querySelectorAll('.s-item')];
      if(!items.length) return;

      if(e.key === 'ArrowDown'){
        e.preventDefault(); activeIndex = (activeIndex + 1) % items.length;
      }else if(e.key === 'ArrowUp'){
        e.preventDefault(); activeIndex = (activeIndex - 1 + items.length) % items.length;
      }else if(e.key === 'Enter'){
        if(activeIndex >= 0){ e.preventDefault(); items[activeIndex].click(); }
        return;
      }else if(e.key === 'Escape'){
        closeSuggestions(); return;
      }else{
        return;
      }
      items.forEach((el,i)=> el.classList.toggle('active', i===activeIndex));
      if(activeIndex>=0) items[activeIndex].scrollIntoView({block:'nearest'});
    }

    // Toolbar simple
    document.querySelectorAll('.toolbar [data-cmd]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.execCommand(btn.dataset.cmd, false, null);
        editor.focus();
      });
    });
    $('#btnClearFormat').onclick = ()=>{
      document.execCommand('removeFormat', false, null);
      document.execCommand('formatBlock', false, 'p');
      editor.focus();
    };

    // Botones principales
    btnLimpiar.onclick = ()=>{
      editor.innerHTML = '';
      apPat.value=''; apMat.value=''; nombres.value='';
      pacienteSel=null; sugerencias=[]; matchName.textContent='';
      setEstado('Esperando datos‚Ä¶'); closeSuggestions();
    };

    btnGuardar.onclick = async ()=>{
      const nombrePlano = `${apPat.value||''} ${apMat.value||''} ${nombres.value||''}`.replace(/\s+/g,' ').trim();
      if(!nombrePlano){ alert('Ingrese el nombre del paciente'); return; }
      const html = editor.innerHTML.trim();
      if(!html){ alert('Escriba la receta en el editor'); return; }

      const payload = {
        pacienteId: pacienteSel?.id ?? null,
        pacienteNombre: pacienteSel ? nombreCompletoDe(pacienteSel) : nombrePlano,
        fecha: (new Date()).toISOString().slice(0,10),
        html
      };
      const resp = await API.crearReceta(payload);
      if(resp && resp.id){
        alert('Receta guardada (ID: '+resp.id+')');
      }else{
        alert('No se pudo guardar la receta');
      }
    };

    btnImprimir.onclick = ()=>{
      const nombrePlano = `${apPat.value||''} ${apMat.value||''} ${nombres.value||''}`.replace(/\s+/g,' ').trim()
        || (pacienteSel && nombreCompletoDe(pacienteSel)) || '‚Äî';
      rxNombre.textContent = nombrePlano;
      rxFecha.textContent  = fechaDDMMYYYY((new Date()).toISOString().slice(0,10));
      rxContent.innerHTML  = editor.innerHTML || '<p>‚Äî</p>';
      window.print();
    };

    // Inputs ‚Üí sugerencias
    [apPat,apMat,nombres].forEach(el=>{
      el.addEventListener('input', updateSuggestions);
      el.addEventListener('keydown', onKeyNav);
      el.addEventListener('blur', ()=> setTimeout(closeSuggestions, 150));
      el.addEventListener('focus', ()=> updateSuggestions());
    });

    // Init
    (function init(){
      try{ if(localStorage.getItem('loggedIn')!=='true') location.href='index.html'; }catch{}
      rxFecha.textContent = fechaDDMMYYYY((new Date()).toISOString().slice(0,10));
      document.addEventListener('click', (e)=>{
        if(!suggest.contains(e.target) && !apPat.contains(e.target) && !apMat.contains(e.target) && !nombres.contains(e.target)){
          closeSuggestions();
        }
      }, true);
    })();
  </script>
</body>
</html>
